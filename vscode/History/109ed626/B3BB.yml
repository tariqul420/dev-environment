name: Deploy to VPS on main

on:
  push:
    branches: ['main']

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: SSH into VPS and deploy portfolio-next
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            # === Deploy portfolio-next ===
            APP_DIR="${{ secrets.PORTFOLIO_PATH }}"
            REPO_URL="https://github.com/YOUR_GH_USER/portfolio-next.git"

            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$APP_DIR"
              git clone "$REPO_URL" "$APP_DIR"
            fi

            cd "$APP_DIR"
            git fetch --all --prune
            git reset --hard origin/main

            if [ -f package-lock.json ]; then
              npm ci --legacy-peer-deps
            else
              npm i --legacy-peer-deps
            fi
            npm run build

            # === PM2 restart both apps via ecosystem ===
            # ecosystem.config.js ধরে নেয়া হয়েছে /var/www/ তে আছে
            if [ -f /var/www/ecosystem.config.js ]; then
              pm2 start /var/www/ecosystem.config.js || true
              pm2 restart /var/www/ecosystem.config.js --update-env
              pm2 save
            else
              # fallback: শুধু এই অ্যাপ রিস্টার্ট
              pm2 restart portfolio-next --update-env || pm2 start npm --name "portfolio-next" -- start
              pm2 save
            fi
