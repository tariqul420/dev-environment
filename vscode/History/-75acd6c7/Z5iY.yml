services:
  natural-sefa:
    build:
      context: .
      dockerfile: ./Dockerfile
      args:
        SKIP_DB: "1" # build only
    container_name: natural-sefa

    env_file:
      - ./.env # runtime secrets (DATABASE_URL, etc.)
    environment:
      - NODE_ENV=production
    expose:
      - "3000"
    restart: unless-stopped
    networks: [proxy]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.naturalsefa.rule=Host(`naturalsefaa.com`)"
      - "traefik.http.routers.naturalsefa.entrypoints=websecure"
      - "traefik.http.routers.naturalsefa.tls.certresolver=letsencrypt"
      - "traefik.http.services.naturalsefa.loadbalancer.server.port=3000"
      - "traefik.http.routers.naturalsefa-www.rule=Host(`www.naturalsefaa.com`)"
      - "traefik.http.routers.naturalsefa-www.entrypoints=websecure"
      - "traefik.http.routers.naturalsefa-www.tls.certresolver=letsencrypt"
      - "traefik.http.routers.naturalsefa-www.middlewares=redirect-to-apex@docker"
      - "traefik.http.middlewares.redirect-to-apex.redirectregex.regex=^https?://www\\.naturalsefaa\\.com/(.*)"
      - "traefik.http.middlewares.redirect-to-apex.redirectregex.replacement=https://naturalsefaa.com/$$1"
      - "traefik.http.middlewares.redirect-to-apex.redirectregex.permanent=true"
